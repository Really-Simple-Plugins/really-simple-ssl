class BaseAuth{constructor(e,t){this.root=e,this.settings=t,this.translatableStrings={keyCopied:this.settings.translatables.keyCopied}}getElement=e=>document.getElementById(e);getCheckedInputValue=e=>document.querySelector(`input[name="${e}"]:checked`).value;performFetchOp=(e,t,n="POST")=>{var e=this.root+e,o={method:n,headers:{"Content-Type":"application/json"}};return"POST"===n&&(o.body=JSON.stringify(t)),fetch(e,o)};assignClickListener=(e,t)=>{e=this.getElement(e);e&&e.addEventListener("click",function(e){e.preventDefault(),t()})};logFetchError=e=>console.error("There has been a problem with your fetch operation:",e);qr_generator=()=>{var e,t=this.settings.totp_data.totp_url;t&&((e=qrcode(0,"L")).addData(t),e.make(),null!=(t=document.querySelector("#two-factor-qr-code a")))&&(t.innerHTML=e.createSvgTag(5))};download_codes=()=>{var e=this.settings.totp_data.backup_codes;let t="";e.forEach(function(e){t+=e+"\n"});e=document.createElement("a");e.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t)),e.setAttribute("download","backup_codes.txt"),e.style.display="none",document.body.appendChild(e),e.click(),document.body.removeChild(e)};copyTextAndShowMessage=()=>{var e=this.settings.totp_data.key;navigator.clipboard.writeText(e).then(()=>{let e=this.getElement("totp-key").innerText;this.getElement("totp-key").innerText=this.translatableStrings.keyCopied,this.getElement("totp-key").style.color="green",setTimeout(()=>{this.getElement("totp-key").innerText=e,this.getElement("totp-key").style.color=""},2e3)},function(e){console.error(this.settings.translatables.keyCopiedFailed,e)})}}window.onload=function(){"undefined"!=typeof rsssl_onboard&&new Onboarding(rsssl_onboard.root,rsssl_onboard).init(),"undefined"!=typeof rsssl_profile&&new Profile(rsssl_profile.root,rsssl_profile).init()};class Onboarding extends BaseAuth{init(){let n=this,o=(["do_not_ask_again","skip_onboarding"].forEach(t=>{var e=this.getElement(t);null!==e&&e.addEventListener("click",e=>{e.preventDefault(),this.performFetchOp("/"+t,this.settings).then(e=>e.json()).then(e=>window.location.href=e.redirect_to).catch(this.logFetchError)})}),this.getElement("rsssl_continue_onboarding"));const s=e=>{e.preventDefault();var t,e=this.getCheckedInputValue("preferred_method");"email"===e?(t={provider:e,redirect_to:this.settings.redirect_to,user_id:this.settings.user_id,login_nonce:this.settings.login_nonce},this.performFetchOp("/save_default_method_email",t).then(e=>e.json()).then(t=>{this.getElement("rsssl_step_one_onboarding").style.display="none",document.getElementById("rsssl_step_three_onboarding").style.display="block",o.addEventListener("click",e=>r(e,t)),o.removeEventListener("click",s)}).catch(n.logFetchError)):"totp"===e&&(this.getElement("rsssl_step_one_onboarding").style.display="none",o.style.display="none",this.getElement("rsssl_step_two_onboarding").style.display="block")},r=async(e,t)=>{e.preventDefault();var e=this.getCheckedInputValue("preferred_method"),t="/"+t.validation_action,e={user_id:this.settings.user_id,login_nonce:this.settings.login_nonce,redirect_to:this.settings.redirect_to,token:document.getElementById("rsssl-authcode").value,provider:e};let n;try{n=await this.performFetchOp(t,e)}catch(e){console.log("Fetch Error: ",e)}n&&!n.ok&&(t=await n.json(),this.displayTwoFaOnboardingError(t.error)),n&&n.ok&&(e=await n.json(),window.location.href=e.redirect_to)};null!==o&&o.addEventListener("click",s);var e=this.getElement("two-factor-totp-submit"),e=(null!==e&&e.addEventListener("click",async e=>{e.preventDefault();var e=document.getElementById("two-factor-totp-authcode").value,t=this.settings.totp_data.key,e={"two-factor-totp-authcode":e,provider:this.getCheckedInputValue("preferred_method"),key:t,redirect_to:this.settings.redirect_to,user_id:this.settings.user_id,login_nonce:this.settings.login_nonce};try{var n,o,s=await this.performFetchOp("/save_default_method_totp",e);s.ok?(n=await s.json(),window.location.href=n.redirect_to):(o=await s.json(),this.displayTwoFaOnboardingError(o.error))}catch(e){this.logFetchError(e)}}),this.getElement("rsssl-two-factor-email-code-resend"));null!==e&&e.addEventListener("click",e=>{e.preventDefault();e={user_id:this.settings.user_id,login_nonce:this.settings.login_nonce,provider:"email"};this.performFetchOp("/resend_email_code",e).then(e=>e.json()).then(e=>{this.displayTwoFaOnboardingError(e.message)}).catch(this.logFetchError)}),this.getElement("download_codes").addEventListener("click",e=>{e.preventDefault(),this.download_codes()}),this.getElement("two-factor-qr-code").addEventListener("click",function(e){e.preventDefault(),n.copyTextAndShowMessage()}),this.getElement("totp-key").addEventListener("click",function(e){e.preventDefault(),n.copyTextAndShowMessage()}),document.readyState,this.qr_generator()}displayTwoFaOnboardingError(t){var n=document.getElementById("two_fa_onboarding_form");if(n){let e=document.getElementById("login-message");e||((e=document.createElement("div")).id="login-message",e.className="notice notice-error message",n.insertAdjacentElement("beforebegin",e)),e.innerHTML=`<p>${t}</p>`,setTimeout(()=>{e.remove()},5e3)}}}class Profile extends BaseAuth{init(){this.assignClickListener("download_codes",this.download_codes),this.assignClickListener("two-factor-qr-code",this.copyTextAndShowMessage),this.assignClickListener("totp-key",this.copyTextAndShowMessage);const n=this.getElement("qr-code-container");var e=this.getElement("two-factor-authentication");const o=this.getElement("selection_two_fa");var s=document.querySelectorAll('input[name="preferred_method"]');const r=document.getElementById("rsssl_verify_email");var t=this.getElement("change_2fa_config");let i=this;if(n&&(n.style.display="none",e.checked||(o.style.display="none",n.style.display="none")),e){let t=this;e.addEventListener("change",function(){var e;this.checked?(o.style.display="table-row",(e=document.querySelector('input[name="preferred_method"]:checked'))&&"totp"===e.value?(n.style.display="block",t.qr_generator()):n.style.display="none"):(o.style.display="none",n.style.display="none",document.querySelector('input[name="preferred_method"]:checked').value="none")})}if(0<s.length){let t=this;s.forEach(function(e){e.addEventListener("change",function(){var e=document.querySelector('input[name="preferred_method"]:checked').value;"totp"===e?(r&&(r.style.display="none"),n.style.display="block",t.qr_generator()):"email"===e?(n.style.display="none",r&&(r.style.display="table-row"),e={provider:e,user_id:rsssl_profile.user_id,login_nonce:document.getElementById("rsssl_two_fa_nonce").value,redirect_to:rsssl_profile.redirect_to},i.performFetchOp("/save_default_method_email_profile",e).then(e=>e.json()).catch(i.logFetchError)):n.style.display="none"})})}e=this.getElement("rsssl_resend_code");null!==e&&e.addEventListener("click",e=>{e.preventDefault();e={user_id:this.settings.user_id,login_nonce:document.getElementById("rsssl_two_fa_nonce").value,provider:"email"};this.performFetchOp("/resend_email_code",e).then(e=>e.json()).then(e=>{let t=document.getElementById("login-message");var n=document.getElementById("rsssl-two-factor-email-code");n&&(t||((t=document.createElement("p")).classList.add("notice","notice-success"),n.insertAdjacentElement("afterend",t)),t.innerHTML=`<p>${e.message}</p>`,setTimeout(()=>{t.remove()},5e3))}).catch(this.logFetchError)}),t&&t.addEventListener("click",function(e){e.preventDefault();e=document.createElement("input");e.setAttribute("type","hidden"),e.setAttribute("name","change_2fa_config_field"),e.setAttribute("value","true"),document.getElementById("change_2fa_config").insertAdjacentElement("afterend",e);document.getElementById("two-factor-authentication").checked=!1;e=document.getElementById("your-profile");e&&e.requestSubmit()})}}